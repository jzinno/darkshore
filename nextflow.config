params.ref_bundle = "/gpfs/commons/groups/landau_lab/jzinno/ref"

profiles {
    test {
        process {
            executor = 'local'
            cpus = 1
            memory = '1 GB'
            time = '1h'
        }
        params{
            bam_list = "test/test-dna-input.txt"
            rna_fastq_table = "test/test-rna-input.txt"
            sample_id = "test"
            call_mito = true
        }
    }
    standard {
        executor {
        queueSize = 196
        }

        singularity {
        enabled = true
        autoMounts = true
        cacheDir = "${System.getenv('HOME')}/.singularity/singularity_images_nextflow"
        }

        process {
            executor = 'slurm'
            queue = { task.accelerator ? 'gpu' : (task.memory > 100.GB ? 'bigmem' : 'cpu') }
            errorStrategy = { task.exitStatus in [143,137,104,134,139,250,255,] ? 'retry' : 'terminate' }
            maxRetries = 2
            maxErrors = '-1'
            cache = 'lenient'
            containerOptions = { task.accelerator ? "--bind ${params.ref_bundle},${projectDir}/.. --nv" : "--bind ${params.ref_bundle},${projectDir}/.." }

            // Resource templates by label
            withLabel: 'small'   { cpus = 1;  memory = { 8.GB   * task.attempt } }
            withLabel: 'trim'    { cpus = 4;  memory = { 8.GB   * task.attempt } }
            withLabel: 'dedup'   { cpus = 2;  memory = { 16.GB  * task.attempt } }
            withLabel: 'medium'  { cpus = 4;  memory = { 16.GB  * task.attempt } }
            withLabel: 'large'   { cpus = 8;  memory = { 32.GB  * task.attempt } }
            withLabel: 'xlarge'  { cpus = 4;  memory = { 64.GB  * task.attempt } }
            withLabel: 'highmem' { cpus = 20; memory = { 100.GB * task.attempt } }
            withLabel: 'jumbo'   { cpus = 32; memory = { 512.GB * task.attempt }; time = '7d' }
            withLabel: 'gpu'     { cpus = 8;  memory = { 96.GB  * task.attempt }; accelerator = 1; clusterOptions = '--gres gpu:1' }
        }
    }
}

executor {
  queueSize = 196
  submitRateLimit = '100/2min'
}

params {
    //input(s) for scVC, scRNA, and Anno respecitively
    fq_list = "fq_list.txt"
    bam_list = "bams.txt"  // A text file with the path to each BAM file on a separate line
    gvcf_list = "gvcf_list.txt"
    joint_vcf = "test.vcf.gz"
    rna_fastq_table="rna_test.txt"
    //output
    out = "output"
    sample_id = "test"
    //resources
    ref = "${params.ref_bundle}/hg38/v0/Homo_sapiens_assembly38.fasta"
    ref_idx = "${params.ref_bundle}/hg38/v0/Homo_sapiens_assembly38.fasta.fai"
    star_ref = "${params.ref_bundle}/refdata-gex-GRCh38-2024-A/star/"
    gtf = "${params.ref_bundle}/refdata-gex-GRCh38-2024-A/genes/genes.gtf"
    te_gtf = "${params.ref_bundle}/TE/GRCh38_GENCODE_rmsk_TE.gtf"
    trust4_vdjc = "${params.ref_bundle}/TRUST4/hg38_bcrtcr.fa"
    trust4_ref = "${params.ref_bundle}/TRUST4/human_IMGT+C.fa"
    //size of scatter intervals (100Mbp)
    chop = 100000000
    //optional flags
    flow_mode = true // true for UG, false for Illumina
    call_mito = false
    use_gpu = true
    // RNA specific settings
    lib_stranded = "no"
    htseq_type = "exon"
    run_trust4 = true
}

report {
    enabled = true
    overwrite = true
    file = "nextflow-report.html"
}

timeline {
    enabled = true
    overwrite = true
    file = "timeline.html"
}

dag {
    enabled = true
    overwrite = true
    file = "flowchart.html"
}

manifest {
    name = "darkshore"
    version = "v0.0.1"
    author = ["John Zinno"]
    homePage = "https://github.com/jzinno/darkshore"
    defaultBranch = "main"
    nextflowVersion = ">=22.10.4"
}
